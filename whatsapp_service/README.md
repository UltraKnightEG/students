# خدمة الواتساب المتقدمة لنظام إدارة حضور الطلاب

## نظرة عامة

خدمة الواتساب المتقدمة هي جزء من نظام إدارة حضور الطلاب، تتيح إرسال الإشعارات والتقارير لأولياء الأمور عبر الواتساب بشكل تلقائي.

## الميزات الرئيسية

### 🔗 إدارة الاتصال
- اتصال تلقائي بالواتساب باستخدام QR Code
- إعادة الاتصال التلقائي عند انقطاع الشبكة
- مراقبة حالة الاتصال المستمرة
- دعم الجلسات المتعددة

### 📱 إرسال الرسائل
- إرسال رسائل فردية وجماعية
- دعم الرسائل النصية والصور
- قائمة انتظار ذكية للرسائل
- تأخير قابل للتخصيص بين الرسائل
- التحقق من صحة أرقام الهواتف

### 📊 التسجيل والمراقبة
- تسجيل شامل لجميع الأنشطة
- سجل الرسائل المرسلة والمستقبلة
- إحصائيات مفصلة للاستخدام
- مراقبة الأداء والأخطاء

### 🔄 المهام المجدولة
- تنظيف السجلات القديمة تلقائياً
- فحص حالة الاتصال دورياً
- إرسال التقارير المجدولة

## متطلبات النظام

### البرمجيات المطلوبة
- Node.js (الإصدار 16.0.0 أو أحدث)
- npm (الإصدار 8.0.0 أو أحدث)
- Google Chrome أو Chromium

### متطلبات النظام
- ذاكرة وصول عشوائي: 512 ميجابايت على الأقل
- مساحة القرص الصلب: 100 ميجابايت
- اتصال إنترنت مستقر

## التثبيت والإعداد

### 1. تثبيت التبعيات

```bash
cd whatsapp_service
npm install
```

### 2. إعداد متغيرات البيئة (اختياري)

إنشاء ملف `.env`:

```env
PORT=3000
HOST=0.0.0.0
NODE_ENV=production
```

### 3. تشغيل الخدمة

#### للتطوير:
```bash
npm run dev
```

#### للإنتاج:
```bash
npm start
```

## استخدام الخدمة

### بدء الجلسة

1. تشغيل الخدمة
2. زيارة `http://localhost:3000/api/qr` للحصول على QR Code
3. مسح QR Code باستخدام تطبيق الواتساب
4. انتظار تأكيد الاتصال

### API المتاحة

#### 1. حالة الخدمة
```http
GET /api/status
```

**الاستجابة:**
```json
{
  "success": true,
  "data": {
    "isConnected": true,
    "connectionStatus": "connected",
    "qrCode": null,
    "messageCount": 150,
    "queueLength": 0,
    "sessionName": "attendance-system"
  }
}
```

#### 2. الحصول على QR Code
```http
GET /api/qr
```

#### 3. إرسال رسالة فردية
```http
POST /api/send
Content-Type: application/json

{
  "to": "966501234567",
  "message": "مرحباً، هذه رسالة تجريبية"
}
```

#### 4. إرسال رسائل جماعية
```http
POST /api/send-bulk
Content-Type: application/json

{
  "recipients": [
    {"phone": "966501234567", "name": "أحمد محمد"},
    {"phone": "966507654321", "name": "فاطمة علي"}
  ],
  "message": "تقرير حضور اليوم...",
  "options": {
    "delay": 2000
  }
}
```

#### 5. التحقق من صحة رقم الهاتف
```http
POST /api/validate-number
Content-Type: application/json

{
  "phone": "966501234567"
}
```

#### 6. سجل الرسائل
```http
GET /api/messages?limit=50&offset=0
```

#### 7. إحصائيات الخدمة
```http
GET /api/stats
```

## التكامل مع النظام الرئيسي

### إرسال تقارير الحضور

```javascript
// مثال على إرسال تقرير حضور
const sendAttendanceReport = async (studentData) => {
  const message = `
📚 تقرير حضور الطالب

👤 الطالب: ${studentData.name}
📅 التاريخ: ${studentData.date}
⏰ وقت الحضور: ${studentData.attendance_time}
📖 المادة: ${studentData.subject}
🏫 الفصل: ${studentData.class_name}

✅ تم تسجيل الحضور بنجاح

شكراً لكم 🌟
  `;

  try {
    const response = await fetch('http://localhost:3000/api/send', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        to: studentData.parent_phone,
        message: message
      })
    });

    const result = await response.json();
    console.log('تم إرسال التقرير:', result);
  } catch (error) {
    console.error('خطأ في إرسال التقرير:', error);
  }
};
```

### إرسال تنبيهات الغياب

```javascript
const sendAbsenceAlert = async (studentData) => {
  const message = `
⚠️ تنبيه غياب

👤 الطالب: ${studentData.name}
📅 التاريخ: ${studentData.date}
📖 المادة: ${studentData.subject}
🏫 الفصل: ${studentData.class_name}

❌ لم يتم تسجيل حضور الطالب

يرجى التواصل مع المدرسة للاستفسار.
  `;

  // إرسال الرسالة...
};
```

## الأمان والحماية

### حماية البيانات
- تشفير جلسات الواتساب
- عدم حفظ كلمات المرور
- تنظيف السجلات القديمة تلقائياً

### حماية من الإساءة
- تحديد معدل الإرسال
- قائمة انتظار للرسائل
- مراقبة الاستخدام

## استكشاف الأخطاء

### مشاكل شائعة

#### 1. فشل في الاتصال
```
خطأ: فشل في تشغيل جلسة الواتساب
```

**الحلول:**
- التأكد من تثبيت Google Chrome
- إعادة تشغيل الخدمة
- حذف مجلد الجلسات وإعادة المحاولة

#### 2. QR Code لا يظهر
```
خطأ: QR Code غير متوفر
```

**الحلول:**
- انتظار بضع ثوانٍ إضافية
- إعادة تشغيل الخدمة
- التأكد من الاتصال بالإنترنت

#### 3. فشل في إرسال الرسائل
```
خطأ: الواتساب غير متصل
```

**الحلول:**
- التحقق من حالة الاتصال
- إعادة مسح QR Code
- التأكد من صحة أرقام الهواتف

### ملفات السجلات

```bash
# عرض السجلات المباشرة
tail -f logs/combined.log

# عرض الأخطاء فقط
tail -f logs/error.log
```

## الصيانة

### تنظيف البيانات

```bash
# حذف جلسات الواتساب القديمة
rm -rf sessions/*

# حذف السجلات القديمة
rm -rf logs/*

# حذف الملفات المؤقتة
rm -rf temp/*
```

### تحديث التبعيات

```bash
# فحص التحديثات المتاحة
npm outdated

# تحديث جميع التبعيات
npm update

# تحديث تبعية محددة
npm install package-name@latest
```

## الدعم الفني

### معلومات الاتصال
- البريد الإلكتروني: support@attendance-system.com
- الهاتف: +966-XX-XXX-XXXX

### الإبلاغ عن المشاكل
يرجى تضمين المعلومات التالية عند الإبلاغ عن مشكلة:
- إصدار Node.js
- نظام التشغيل
- رسالة الخطأ الكاملة
- خطوات إعادة إنتاج المشكلة

## الترخيص

هذا المشروع مرخص تحت رخصة MIT. راجع ملف LICENSE للمزيد من التفاصيل.

## المساهمة

نرحب بالمساهمات! يرجى قراءة دليل المساهمة قبل تقديم طلبات السحب.

---

**ملاحظة:** هذه الخدمة مصممة للاستخدام التعليمي وتتطلب الامتثال لشروط استخدام الواتساب.

